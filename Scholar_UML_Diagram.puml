@startuml Scholar Class Diagram
scale 1.2
left to right direction

skinparam monochrome true
skinparam shadowing false
skinparam backgroundColor white
skinparam defaultFontColor black

skinparam ranksep 0.9
skinparam nodesep 0.8
skinparam linetype ortho

hide empty members
hide circle
hide stereotype
skinparam classAttributeIconSize 0
skinparam classVisibilityIconSize 0

skinparam class {
    AttributeFontSize 9
    FontSize 10
    Padding 6
    BackgroundColor white
    BorderColor black
    ArrowColor black
    BorderThickness 1
}
skinparam defaultFontSize 10

' Core Domain Classes
class Student {
  -name: string
  -surname: string
  -course: int
  -semester: int
  -averageGrade: double
  -isBudget: bool
  -scholarship: double
  -missedHours: int
  -hasSocialScholarship: bool
  -previousSemesterGrades: map
  -previousSemesterScholarships: map
  -budgetSemester: int
  +Student(string_view, string_view, int, int, double, bool)
  +getName(): string
  +getSurname(): string
  +getCourse(): int
  +getSemester(): int
  +getAverageGrade(): double
  +getIsBudget(): bool
  +getMissedHours(): int
  +getHasSocialScholarship(): bool
  +getPreviousSemesterGrades(): map
  +getPreviousSemesterScholarships(): map
  +getBudgetSemester(): int
  +getScholarship(): double
  +getFullName(): string
  +getStudentInfo(): string
  +getHistoryString(): string
  +setName(string_view)
  +setSurname(string_view)
  +setCourse(int)
  +setSemester(int)
  +setAverageGrade(double)
  +setIsBudget(bool)
  +setMissedHours(int)
  +setHasSocialScholarship(bool)
  +setScholarship(double)
  +addPreviousGrade(int, double)
  +clearPreviousGrades(): void
  +recalculateScholarship(): void
  +calculateAverageGrade(): double
  -saveScholarshipsForBudgetSemesters(int): void
  -saveHistoricalScholarships(): void
  -isEligibleForScholarship(): bool
  -calculateCurrentScholarship(): void
  -saveCurrentScholarshipToHistory(): void
}

class Scholarship {
  -amount: double
  -isSocial: bool
  -semester: int
  +Scholarship(double, bool, int)
  +getAmount(): double
  +getIsSocial(): bool
  +getSemester(): int
  +setAmount(double)
  +setIsSocial(bool)
  +setSemester(int)
  +{static} SCHOLARSHIP_5_0_5_9: double
  +{static} SCHOLARSHIP_6_0_7_9: double
  +{static} SCHOLARSHIP_8_0_8_9: double
  +{static} SCHOLARSHIP_9_0_10_0: double
  +{static} SOCIAL_SCHOLARSHIP: double
  +{static} calculateScholarshipAmount(double): double
  +{static} getScholarshipBracket(double): string
}

' Manager Classes
class StudentDatabase {
  -students: vector<shared_ptr<Student>>
  -filename: string
  +StudentDatabase()
  +addStudent(shared_ptr<Student>): void
  +addStudent(string_view, string_view, int, int, double, bool): void
  +removeStudent(string_view, string_view): bool
  +removeStudent(size_t): bool
  +removeStudentPtr(shared_ptr<Student>): bool
  +getStudent(size_t): shared_ptr<Student>
  +getAllStudents(): vector<shared_ptr<Student>>
  +getStudentCount(): size_t
  +searchStudents(Predicate): vector<shared_ptr<Student>>
  +searchByName(string_view): vector<shared_ptr<Student>>
  +searchBySurname(string_view): vector<shared_ptr<Student>>
  +searchByAverageGrade(double, double): vector<shared_ptr<Student>>
  +searchByAverageAtLeast(double): vector<shared_ptr<Student>>
  +searchByAverageEqual(double): vector<shared_ptr<Student>>
  +searchByCourse(int): vector<shared_ptr<Student>>
  +saveToFile(string_view): bool
  +loadFromFile(string_view): bool
  +setFilename(string_view): void
  +clear(): void
}

class StudentTableManager {
  -table: QTableWidget*
  +StudentTableManager(QTableWidget*, QObject*)
  +configure(QObject*): void
  +populate(vector<shared_ptr<Student>>, bool): void
  +updateRowNumbers(): void
  -ensureScholarshipColumn(bool): void
  -applyMissedHoursStyling(): void
  -createActionButtons(int): QWidget*
  -setupColumnWidths(bool): void
  -createRowItems(int, int&, shared_ptr<Student>, QFont&, QColor&, bool): void
  -createNumberItem(int, QFont&): QTableWidgetItem*
  -createMissedHoursItem(shared_ptr<Student>, QFont&, QColor&): QTableWidgetItem*
  -createScholarshipItem(double, QFont&): QTableWidgetItem*
  -applyItemForegroundColor(QTableWidgetItem*, int, QColor&): void
  -shouldSkipColumn(int): bool
  -updateSelectionVisual(): void
  -onEditClicked(): void
  -onDeleteClicked(): void
  -onViewClicked(): void
}

' Service Classes
class ScholarshipCalculator {
  +{static} SCHOLARSHIP_5_0_5_9: double
  +{static} SCHOLARSHIP_6_0_7_9: double
  +{static} SCHOLARSHIP_8_0_8_9: double
  +{static} SCHOLARSHIP_9_0_10_0: double
  +{static} SOCIAL_SCHOLARSHIP: double
  +{static} calculateScholarship(double): double
  +{static} calculateScholarshipForStudent(Student*): double
  +{static} getScholarshipBracket(double): string
}

class StudentStatisticsUpdater {
  +updateGeneralStatistics(vector<shared_ptr<Student>>, QLabel*, QLabel*, QLabel*, QLabel*): void
  +updateSemesterTable(vector<shared_ptr<Student>>, QTableWidget*): void
  -getYearForSemester(int): int
  -getYearForSemester(int, int): int
  -collectAllSemesters(shared_ptr<Student>): set<int>
  -getYearSemesters(int): vector<int>
  -wasStudentInYear(set<int>&, vector<int>&): bool
  -wasOnSummerSemester(set<int>&, vector<int>&): bool
  -calculateWinterScholarship(shared_ptr<Student>, int, vector<int>&, int): double
  -calculateSummerScholarship(shared_ptr<Student>, int, vector<int>&, int): double
  -getScholarshipFromHistory(shared_ptr<Student>, int): double
  -populateTableRows(QTableWidget*, map<int, YearStats>&): void
}

class HistoryGradeGenerator {
  +HistoryGradeGenerator()
  +ensureHistoryForNewStudent(Student&, int): void
  +handleSemesterChange(Student&, int, double, int): void
  +fillMissingHistoryForAll(vector<shared_ptr<Student>>): void
  -generateRandomGrade(): double
}

' Exception Classes
class ScholarshipException {
  -message: string
  +what(): const char*
}

class FileIOException {
  -message: string
  +what(): const char*
}

class FileNotFoundException {
  -message: string
  +what(): const char*
}

class FileWriteException {
  -message: string
  +what(): const char*
}

class ParseException {
  -message: string
  +what(): const char*
}

class InvalidDataFormatException {
  -message: string
  +what(): const char*
}

class ValidationException {
  -message: string
  +what(): const char*
}

class InvalidStudentDataException {
  -message: string
  +what(): const char*
}

class InvalidGradeException {
  -message: string
  +what(): const char*
}

class InvalidCourseException {
  -message: string
  +what(): const char*
}

class InvalidSemesterException {
  -message: string
  +what(): const char*
}

class EmptyNameException {
  -message: string
  +what(): const char*
}

class DatabaseException {
  -message: string
  +what(): const char*
}

class StudentNotFoundException {
  -message: string
  +what(): const char*
}

class DuplicateStudentException {
  -message: string
  +what(): const char*
}

' UI Classes
class MainWindow {
  -database: StudentDatabase
  -tabWidget: QTabWidget*
  -studentTable: QTableWidget*
  -searchEdit: QLineEdit*
  -searchButton: QPushButton*
  -addStudentButton: QPushButton*
  -totalStudentsLabel: QLabel*
  -budgetStudentsLabel: QLabel*
  -paidStudentsLabel: QLabel*
  -totalScholarshipLabel: QLabel*
  -calculateButton: QPushButton*
  -semesterStatsTable: QTableWidget*
  -currentView: vector<shared_ptr<Student>>
  -scholarshipsCalculated: bool
  -scholarshipsNeedRecalculation: bool
  -recalculationWarning: QLabel*
  -tableManager: unique_ptr<StudentTableManager>
  -statisticsUpdater: StudentStatisticsUpdater
  -historyGradeGenerator: HistoryGradeGenerator
  -historyDialog: unique_ptr<StudentHistoryDialog>
  +MainWindow(QWidget*)
  +~MainWindow()
  +eventFilter(QObject*, QEvent*): bool
  -setupUI(): void
  -createTabs(): void
  -createStudentsTab(QWidget*): void
  -createStatisticsTab(QWidget*): void
  -createStudentTable(): void
  -updateStatistics(): void
  -fillMissingHistoryGrades(): void
  -saveDatabaseToFile(): void
  -addStudent(): void
  -searchStudent(): void
  -calculateAllScholarships(): void
  -showAllStudents(): void
  -updateStudentTable(vector<shared_ptr<Student>>): void
  -editSelectedStudent(): void
  -deleteSelectedStudent(): void
  -showStudentHistory(): void
}

class StudentDialogBuilder {
  -parentWidget: QWidget*
  +StudentDialogBuilder(QWidget*)
  +showAddDialog(): StudentDialogResult
  +showEditDialog(shared_ptr<Student>): StudentDialogResult
  -showDialog(QString, QString, QString, shared_ptr<Student>): StudentDialogResult
  -buildDialogStyle(): QString
  -configureSemesterSpinBox(QSpinBox*): void
  -setupDialog(QDialog*, QString): void
  -createFormLayout(QDialog*): QFormLayout*
  -createFields(QDialog*, shared_ptr<Student>): DialogFields
  -addFieldsToForm(QFormLayout*, DialogFields&): void
  -createButtonBox(QDialog*, QString): QDialogButtonBox*
  -connectButtonBox(QDialogButtonBox*, QDialog*): void
  -validateAndFillResult(DialogFields&, StudentDialogResult&, QString): bool
}

class StudentDialogResult {
  -accepted: bool
  -name: QString
  -surname: QString
  -semester: int
  -averageGrade: double
  -budget: bool
  -missedHours: int
  -socialScholarship: bool
  +StudentDialogResult()
  +isAccepted(): bool
  +setAccepted(bool)
  +getName(): QString
  +setName(QString)
  +getSurname(): QString
  +setSurname(QString)
  +getSemester(): int
  +setSemester(int)
  +getAverageGrade(): double
  +setAverageGrade(double)
  +isBudget(): bool
  +setIsBudget(bool)
  +getMissedHours(): int
  +setMissedHours(int)
  +hasSocialScholarship(): bool
  +setHasSocialScholarship(bool)
}

class DialogFields {
  +nameField: QLineEdit*
  +surnameField: QLineEdit*
  +semesterField: QSpinBox*
  +avgField: QDoubleSpinBox*
  +fundingField: QComboBox*
  +missedHoursField: QSpinBox*
  +socialField: QCheckBox*
}

class StudentHistoryDialog {
  -parentWidget: QWidget*
  +StudentHistoryDialog(QWidget*)
  +showHistory(shared_ptr<Student>): void
  -getAdmissionYearFromSemester(int): int
  -getYearForSemester(int, int): int
  -getSessionTypeForSemester(int): QString
  -setupCurrentInfoTable(QDialog*, QVBoxLayout*): QTableWidget*
  -populateCurrentInfoTable(QTableWidget*, shared_ptr<Student>): void
  -setupHistoryTable(QDialog*): QTableWidget*
  -populateHistoryTable(QTableWidget*, shared_ptr<Student>, int): void
  -calculateScholarshipForSemester(shared_ptr<Student>, int, double): double
  -createHistoryRow(QTableWidget*, int, int, double, double, int): void
}

' Inheritance Relationships
ScholarshipException <|-- FileIOException
ScholarshipException <|-- ParseException
ScholarshipException <|-- ValidationException
ScholarshipException <|-- DatabaseException

FileIOException <|-- FileNotFoundException
FileIOException <|-- FileWriteException

ParseException <|-- InvalidDataFormatException

ValidationException <|-- InvalidStudentDataException
ValidationException <|-- InvalidGradeException
ValidationException <|-- InvalidCourseException
ValidationException <|-- InvalidSemesterException
ValidationException <|-- EmptyNameException

DatabaseException <|-- StudentNotFoundException
DatabaseException <|-- DuplicateStudentException

' Composition/Aggregation Relationships
StudentDatabase "1" *-- "0..*" Student : manages

MainWindow "1" *-- "1" StudentDatabase : contains
MainWindow "1" *-- "1" StudentTableManager : contains
MainWindow "1" *-- "1" StudentStatisticsUpdater : contains
MainWindow "1" *-- "1" HistoryGradeGenerator : contains
MainWindow "1" *-- "1" StudentHistoryDialog : contains

StudentDialogBuilder "1" *-- "1" StudentDialogResult : creates
StudentDialogBuilder "1" *-- "1" DialogFields : uses

' Reference Relationships
MainWindow ..> StudentDatabase : uses
MainWindow ..> StudentTableManager : uses
MainWindow ..> StudentStatisticsUpdater : uses
MainWindow ..> HistoryGradeGenerator : uses
MainWindow ..> StudentHistoryDialog : uses

StudentTableManager ..> Student : displays
StudentStatisticsUpdater ..> Student : processes
HistoryGradeGenerator ..> Student : modifies
ScholarshipCalculator ..> Student : calculates for
StudentHistoryDialog ..> Student : displays

StudentDialogBuilder ..> Student : edits
StudentHistoryDialog ..> Student : shows

' Exception Relationships
StudentDatabase ..> FileIOException : throws
StudentDatabase ..> ParseException : throws
StudentDatabase ..> ValidationException : throws
StudentDatabase ..> DatabaseException : throws
StudentDatabase ..> DuplicateStudentException : throws
StudentDatabase ..> StudentNotFoundException : throws

Student ..> ValidationException : throws
Student ..> InvalidGradeException : throws
Student ..> InvalidCourseException : throws
Student ..> InvalidSemesterException : throws
Student ..> EmptyNameException : throws

' Note about utility classes
note right of ScholarshipCalculator
  Static utility class
  Calculates scholarship amounts
  based on average grade
end note

note right of StudentStatisticsUpdater
  Service class for updating
  statistics and semester tables
end note

note right of HistoryGradeGenerator
  Service class for generating
  and managing student grade history
end note

note right of StudentTableManager
  QObject-based manager
  Handles QTableWidget operations
  and signals/slots
end note

@enduml

